---
output: html_document
editor_options: 
  chunk_output_type: console
---


```{r libraries}

library(tidyverse)
library(magrittr)
# library(ggpubr)
# library(RColorBrewer)
library(colorspace)

```


```{r colors}

cbPalette <- c("#E69F00", # orange
               "#56B4E9", # lightblue
               "#009E73", # green
               "#F0E442", # yellow
               "#0072B2", # darkblue
               "#D55E00", # red
               "#CC79A7") # cyan

```


```{r data}

data <- 
  read_delim("../results/output_test3.csv", 
             delim = ";") %>% 
  mutate(scenario = str_c(e_step_CC, time_CC, sep = "_")) 


data <- 
  read_delim("../results/output_X11_Y3_tl1_loci10_mu1e-4_oe25e-2_d2e-1_dp5e-1_Yrange1e-1_stepLocal2e-3_sex_CC2e-4_2e3.csv", 
             delim = ";") %>% 
  bind_rows(read_delim("../results/output_X11_Y3_tl1_loci10_mu1e-4_oe25e-2_d2e-1_dp5e-1_Yrange1e-1_stepLocal2e-3_sex_CC2e-4_1e3.csv", 
                       delim = ";")) %>% 
  bind_rows(read_delim("../results/output_X11_Y3_tl1_loci10_mu0_oe25e-2_d2e-1_dp5e-1_Yrange1e-1_stepLocal2e-3_sex_CC2e-4_2e3.csv", 
                       delim = ";")) %>% 
  bind_rows(read_delim("../results/output_X11_Y3_tl1_loci10_mu0_oe25e-2_d2e-1_dp5e-1_Yrange1e-1_stepLocal2e-3_sex_CC2e-4_1e3.csv", 
                       delim = ";")) %>% 
  mutate(scenario = str_c(e_step_CC, time_CC, sep = "_")) 

data <- 
  read_delim("../results/output_X11_Y4_tl1_loci10_mu0_oe25e-2_d2e-1_dp5e-1_Yrange1e-1_stepLocal2e-3_specPatch_sex_CC2e-4_1e3.csv", 
             delim = ";") %>% 
  bind_rows(read_delim("../results/output_X11_Y4_tl1_loci10_mu1e-4_oe25e-2_d2e-1_dp5e-1_Yrange1e-1_stepLocal2e-3_specPatch_sex_CC2e-4_1e3.csv", 
                       delim = ";")) %>% 
  mutate(scenario = str_c(e_step_CC, time_CC, sep = "_")) 

data <- 
  read_delim("../results/output_X11_Y4_tl2_loci10_mu0_oe25e-2_d2e-1_dp5e-1_Yrange1e-1_stepLocal2e-3_specPatch_sex_CC2e-4_1e3.csv", 
             delim = ";") %>% 
  bind_rows(read_delim("../results/output_X11_Y4_tl2_loci10_mu1e-4_oe25e-2_d2e-1_dp5e-1_Yrange1e-1_stepLocal2e-3_specPatch_sex_CC2e-4_1e3.csv", 
                       delim = ";")) %>% 
  mutate(scenario = str_c(e_step_CC, time_CC, sep = "_")) 


data <- 
  read_delim("../results/output_X5_Y3_tl2_loci10_mu0_oe25e-2_d2e-1_dp5e-1_Yrange1e-1_stepLocal2e-3_specPatch_sex_CC2e-4_1e3.csv", 
             delim = ";") %>% 
  bind_rows(read_delim("../results/output_X5_Y3_tl2_loci10_mu1e-4_oe25e-2_d2e-1_dp5e-1_Yrange1e-1_stepLocal2e-3_specPatch_sex_CC2e-4_1e3.csv", 
                       delim = ";")) %>% 
  mutate(scenario = str_c(e_step_CC, time_CC, sep = "_")) 


data <- 
  read_delim("../results/output_X5_Y5_tl1_loci10_mu0_oe25e-2_d2e-1_dp5e-1_Yrange1e-1_stepLocal2e-3_specPatch_sex_CC2e-4_1e3.csv", 
             delim = ";") %>% 
  bind_rows(read_delim("../results/output_X5_Y5_tl1_loci10_mu1e-4_oe25e-2_d2e-1_dp5e-1_Yrange1e-1_stepLocal2e-3_specPatch_sex_CC2e-4_1e3.csv", 
                       delim = ";")) %>% 
  bind_rows(read_delim("../results/output_X5_Y3_tl1_loci10_mu0_oe25e-2_d2e-1_dp5e-1_Yrange1e-1_stepLocal2e-3_specPatch_sex_CC2e-4_1e3.csv",
                       delim = ";")) %>%
  bind_rows(read_delim("../results/output_X5_Y3_tl1_loci10_mu1e-4_oe25e-2_d2e-1_dp5e-1_Yrange1e-1_stepLocal2e-3_specPatch_sex_CC2e-4_1e3.csv",
                       delim = ";")) %>%
  mutate(scenario = str_c(e_step_CC, time_CC, sep = "_")) 

data <- 
  read_delim("../results/output_X5_Y5_tl1_loci10_mu0_oe25e-2_d2e-1_dp5e-1_Yrange1e-1_stepLocal2e-3_specX_sex_CC2e-4_1e3.csv", 
             delim = ";") %>% 
  bind_rows(read_delim("../results/output_X5_Y5_tl1_loci10_mu1e-4_oe25e-2_d2e-1_dp5e-1_Yrange1e-1_stepLocal2e-3_specX_sex_CC2e-4_1e3.csv", 
                       delim = ";")) %>% 
  bind_rows(read_delim("../results/output_X5_Y3_tl1_loci10_mu0_oe25e-2_d2e-1_dp5e-1_Yrange1e-1_stepLocal2e-3_specX_sex_CC2e-4_1e3.csv",
                       delim = ";")) %>%
  bind_rows(read_delim("../results/output_X5_Y3_tl1_loci10_mu1e-4_oe25e-2_d2e-1_dp5e-1_Yrange1e-1_stepLocal2e-3_specX_sex_CC2e-4_1e3.csv",
                       delim = ";")) %>%
  mutate(scenario = str_c(e_step_CC, time_CC, sep = "_")) 


data <- 
  read_delim("../results/output_X5_Y5_tl1_loci10_mu0_oe25e-2_d2e-1_dp5e-1_Yrange1e-1_stepLocal2e-3_specPatch_sex_CC2e-4_1e3.csv", 
             delim = ";") %>% 
  bind_rows(read_delim("../results/output_X5_Y5_tl1_loci10_mu1e-4_oe25e-2_d2e-1_dp5e-1_Yrange1e-1_stepLocal2e-3_specPatch_sex_CC2e-4_1e3.csv", 
                       delim = ";")) %>% 
  mutate(scenario = str_c(e_step_CC, time_CC, sep = "_")) 

data <- 
  read_delim("../results/output_X5_Y5_tl2_loci10_mu0_oe25e-2_d2e-1_dp5e-1_Yrange1e-1_stepLocal2e-3_specPatch_sex_CC2e-4_1e3.csv", 
             delim = ";") %>% 
  bind_rows(read_delim("../results/output_X5_Y5_tl2_loci10_mu1e-4_oe25e-2_d2e-1_dp5e-1_Yrange1e-1_stepLocal2e-3_specPatch_sex_CC2e-4_1e3.csv", 
                       delim = ";")) %>% 
  mutate(scenario = str_c(e_step_CC, time_CC, sep = "_")) 

data <- 
  read_delim("../results/output_X5_Y5_tl3_loci10_mu0_oe25e-2_d2e-1_dp5e-1_Yrange1e-1_stepLocal2e-3_specPatch_sex_CC2e-4_1e3.csv", 
             delim = ";") %>% 
  bind_rows(read_delim("../results/output_X5_Y5_tl3_loci10_mu1e-4_oe25e-2_d2e-1_dp5e-1_Yrange1e-1_stepLocal2e-3_specPatch_sex_CC2e-4_1e3.csv", 
                       delim = ";")) %>% 
  mutate(scenario = str_c(e_step_CC, time_CC, sep = "_")) 


```


```{r calculations}

tls <- max(data$trophic_level)  
nX <- max(data$X)
nY <- max(data$Y)

data <- 
  data %>% 
  # filter(run == 1) %>% 
  mutate(origin = (species+tls-1)%/%tls,
         origin_X = ((origin-1)%%nX)+1,
         origin_Y = ((origin-1)%/%nX)+1,
         origin = ordered(origin),
         origin_X = ordered(origin_X),
         origin_Y = ordered(origin_Y),
         species = ordered(species),
         trophic_level = ordered(trophic_level),
         run = ordered(run),
         patch = ordered(patch),
         X = ordered(X),
         Y = ordered(Y))

data_origin <-
  data %>%
  distinct(species, trophic_level, origin, origin_X, origin_Y)


data_div_alpha <-
  data %>% 
  mutate(run = ordered(run)) %>% 
  filter(N > 0) %>% 
  group_by(scenario, grid_X, grid_Y, mu, run, time, patch, X, Y, trophic_level) %>%
  # group_by(mu, run, time, patch, X, Y) %>% 
  mutate(p_N = N/sum(N),
         p_biomass = biomass/sum(biomass)) %>%
  summarise(alpha_H_N = -sum(p_N*log(p_N)),
            alpha_H_biomass = -sum(p_biomass*log(p_biomass))) %>% 
  ungroup() %>% 
  mutate(# alpha_div_N = exp(alpha_H_N),
         alpha_div_biomass = exp(alpha_H_biomass)) %>%
  group_by(scenario, grid_X, grid_Y, mu, run, time, trophic_level) %>%
  # group_by(mu, run, time) %>% 
  summarise(alpha_div_N = exp((-1/n())*sum(-alpha_H_N)),
            alpha_div_biomass = exp((-1/n())*sum(-alpha_H_biomass)),
            alpha_H_N = mean(alpha_H_N),
            alpha_H_biomass = mean(alpha_H_biomass),
            # alpha_div_N = mean(alpha_div_N),
            # alpha_div_biomass = mean(alpha_div_biomass)
            ) %>% 
  ungroup()
  
data_div_gamma <-
  data %>% 
  mutate(run = ordered(run)) %>% 
  filter(N > 0) %>% 
  group_by(scenario, grid_X, grid_Y, mu, run, time, species, trophic_level) %>%
  # group_by(mu, run, time, species) %>%
  summarise(N = sum(N),
            biomass = sum(biomass)) %>% 
  ungroup() %>% 
  group_by(scenario, grid_X, grid_Y, mu, run, time, trophic_level) %>%
  # group_by(mu, run, time) %>%
  mutate(p_N = N/sum(N),
         p_biomass = biomass/sum(biomass)) %>%
  summarise(gamma_H_N = -sum(p_N*log(p_N)),
            gamma_H_biomass = -sum(p_biomass*log(p_biomass))) %>% 
  ungroup() %>% 
  mutate(gamma_div_N = exp(gamma_H_N),
         gamma_div_biomass = exp(gamma_H_biomass)) %>% 
  group_by(scenario, grid_X, grid_Y, mu, run, time, trophic_level) %>%
  # group_by(mu, run, time) %>% 
  summarise(gamma_H_N = mean(gamma_H_N),
            gamma_H_biomass = mean(gamma_H_biomass),
            gamma_div_N = mean(gamma_div_N),
            gamma_div_biomass = mean(gamma_div_biomass)) %>% 
  ungroup()


data_div <-
  data_div_alpha %>% 
  left_join(data_div_gamma) %>% 
  mutate(beta_H_N = gamma_H_N-alpha_H_N,
         beta_H_biomass = gamma_H_biomass-alpha_H_biomass,
         beta_div_N = gamma_div_N/alpha_div_N,
         beta_div_biomass = gamma_div_biomass/alpha_div_biomass) %>% 
  select(-run) %>% 
  group_by(scenario, grid_X, grid_Y, mu, time, trophic_level) %>%
  # group_by(mu, time) %>% 
  summarise(across(.fns = ~mean(.))) %>% 
  ungroup() %>% 
  mutate(mu = ordered(mu))

# analysis shift from origin
data_shift <-
  data %>% 
  mutate(run = ordered(run)) %>% 
  filter(N > 0) %>% 
  mutate(X = as.numeric(as.character(X))) %>% 
  group_by(scenario, grid_X, grid_Y, mu, run, time, species, trophic_level) %>%
  summarise(X_mean = mean(rep(X,N)),
            X_spread = sqrt(var(rep(X,N)))) %>% 
  ungroup() %>% 
  group_by(scenario, grid_X, grid_Y, mu, run, species, trophic_level) %>%
  mutate(X_shift = abs(X_mean - X_mean[time == 0])) %>% 
  ungroup() %>% 
  group_by(scenario, grid_X, grid_Y, mu, run, time, trophic_level) %>%
  summarise(X_spread = mean(X_spread),
            X_shift = mean(X_shift)) %>% 
  ungroup()

data_shift_mean <-
  data_shift %>% 
  group_by(scenario, grid_X, grid_Y, mu, time, trophic_level) %>% 
  summarise(across(c(X_spread, X_shift), mean)) %>% 
  ungroup()

```


```{r figuren density}

for(r in levels(data$run)) {
  for(g_y in unique(data$grid_Y)) {
    for(tl in levels(data$trophic_level)) {
      for(mut in unique(data$mu)) {
        data %>% 
          filter(#time <= 1000,
            run == r,
            grid_Y == g_y,
            trophic_level == tl,
            mu == mut) %>%
          {ggplot(., aes(x = time)) +
              geom_line(aes(y = N, color = species), linetype = 1, size = 1) +
              scale_color_discrete_qualitative() +
              # scale_y_log10() +
              # facet_grid(Y ~ X, labeller = "label_both") +
              facet_grid(X ~ Y, labeller = "label_both") +
              ggtitle(str_c("Run ", r, "; trophic level ", tl, "; mu ", mut)) +
              guides(color = "none")} %>% 
          print()
      }
    }
  }
}

# figs_dens <-
#   data %>% 
#   group_by(run, trophic_level, mu) %>% 
#   nest() %>% 
#   transmute(fig = map(data, 
#                       ~{ggplot(., aes(x = time)) +
#                           geom_line(aes(y = N, color = species), linetype = 1, size = 1) +
#                           scale_color_discrete_qualitative() +
#                           facet_grid(X ~ Y, labeller = "label_both") +
#                           ggtitle(str_c("Run ", r, "; trophic level ", tl)) +
#                           guides(color = "none")}))
# 
# 
# map(figs_dens$fig, print)

```


```{r figuren div}

data_div_alpha %>% 
  ggplot(aes(time, alpha_div_N)) +
  geom_line(aes(color = run)) +
  facet_grid(trophic_level ~ mu, labeller = "label_both")

data_div_gamma %>% 
  ggplot(aes(time, gamma_div_N)) +
  geom_line(aes(color = run)) +
  facet_grid(trophic_level ~ mu, labeller = "label_both")

data_div %>% 
  select(trophic_level, mu, time, contains("div_N")) %>% 
  pivot_longer(cols = contains("div_N"),
               names_to = "level",
               values_to = "div_N") %>% 
  mutate(level = str_remove(level, "_div_N")) %>% 
  ggplot(aes(time, div_N, color = level)) +
  geom_line(aes(linetype = level), size = 1) +
  facet_grid(trophic_level ~ mu, labeller = "label_both")

data_div %>% 
  select(trophic_level, mu, time, contains("div_N")) %>% 
  filter(time == 11000) %>% 
  pivot_longer(cols = contains("div_N"),
               names_to = "level",
               values_to = "div_N") %>% 
  mutate(level = str_remove(level, "_div_N")) %>% 
  ggplot(aes(trophic_level, div_N, fill = trophic_level)) +
  geom_col() +
  facet_grid(mu ~ level, labeller = "label_both") +
  scale_x_discrete(labels = NULL)

data_div %>% 
  select(trophic_level, grid_Y, mu, time, contains("div_N")) %>% 
  # filter(time == 11000) %>% 
  filter(time == max(time)) %>%
  # filter(time == 5000 | time == max(time)) %>% 
  pivot_longer(cols = contains("div_N"),
               names_to = "level",
               values_to = "div_N") %>% 
  mutate(level = str_remove(level, "_div_N"),
         time = ordered(time)) %>% 
  ggplot(aes(time, div_N, fill = mu)) +
  geom_col(position = "dodge") +
  # scale_y_log10() +
  facet_grid(level ~ trophic_level + grid_Y, labeller = "label_both", scales = "free_y") +
  scale_x_discrete(labels = NULL)

data_div %>% 
  select(trophic_level, grid_Y, mu, time, contains("div_N")) %>% 
  # filter(time == 11000) %>% 
  filter(time == max(time)) %>%
  # filter(time == 5000 | time == max(time)) %>% 
  group_by(trophic_level, grid_Y, time) %>% 
  summarise(alpha_div_ratio = alpha_div_N[mu == 1e-4]/alpha_div_N[mu == 0],
            beta_div_ratio = beta_div_N[mu == 1e-4]/beta_div_N[mu == 0],
            gamma_div_ratio = gamma_div_N[mu == 1e-4]/gamma_div_N[mu == 0]) %>% 
  ungroup() %>% 
  pivot_longer(cols = contains("div_ratio"),
               names_to = "level",
               values_to = "div_ratio") %>% 
  mutate(level = str_remove(level, "_div_ratio"),
         time = ordered(time)) %>% 
  ggplot(aes(level, div_ratio)) +
  geom_col() +
  scale_y_log10() +
  # scale_y_log10(breaks = c(0.5,0.8,1,1.2,1.5)) +
  facet_grid(trophic_level ~ grid_Y, labeller = "label_both")

```


```{r figuren shift & spread}

data_shift %>% 
  ggplot(aes(time, X_shift)) +
  geom_line(aes(color = run)) +
  facet_grid(trophic_level ~ mu, labeller = "label_both")

data_shift_mean %>% 
  filter(time == max(time)) %>% 
  ggplot(aes(ordered(mu), X_shift)) +
  geom_col() +
  facet_grid(trophic_level ~ scenario, labeller = "label_both")

data_shift %>% 
  ggplot(aes(time, X_spread)) +
  geom_line(aes(color = run)) +
  facet_grid(trophic_level ~ mu, labeller = "label_both")

data_shift_mean %>% 
  filter(time == max(time)) %>% 
  ggplot(aes(ordered(mu), X_spread)) +
  geom_col() +
  facet_grid(trophic_level ~ scenario, labeller = "label_both")

```

